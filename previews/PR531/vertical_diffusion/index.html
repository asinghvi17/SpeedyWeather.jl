<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Vertical diffusion · SpeedyWeather.jl</title><meta name="title" content="Vertical diffusion · SpeedyWeather.jl"/><meta property="og:title" content="Vertical diffusion · SpeedyWeather.jl"/><meta property="twitter:title" content="Vertical diffusion · SpeedyWeather.jl"/><meta name="description" content="Documentation for SpeedyWeather.jl."/><meta property="og:description" content="Documentation for SpeedyWeather.jl."/><meta property="twitter:description" content="Documentation for SpeedyWeather.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">SpeedyWeather.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../installation/">Installation</a></li><li><input class="collapse-toggle" id="menuitem-3" type="checkbox"/><label class="tocitem" for="menuitem-3"><span class="docs-label">Dynamics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../barotropic/">Barotropic model</a></li><li><a class="tocitem" href="../shallowwater/">Shallow water model</a></li><li><a class="tocitem" href="../primitiveequation/">Primitive equation model</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4" type="checkbox" checked/><label class="tocitem" for="menuitem-4"><span class="docs-label">Physics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../large_scale_condensation/">Large-scale condensation</a></li><li><a class="tocitem" href="../convection/">Convection</a></li><li><a class="tocitem" href="../radiation/">Radiation</a></li><li class="is-active"><a class="tocitem" href>Vertical diffusion</a><ul class="internal"><li><a class="tocitem" href="#Implementations"><span>Implementations</span></a></li><li><a class="tocitem" href="#Laplacian-in-sigma-coordinates"><span>Laplacian in sigma coordinates</span></a></li><li><a class="tocitem" href="#Bulk-Richardson-based-diffusion-coefficient"><span>Bulk Richardson-based diffusion coefficient</span></a></li><li><a class="tocitem" href="#Vertical-diffusion-tendencies"><span>Vertical diffusion tendencies</span></a></li><li><a class="tocitem" href="#References"><span>References</span></a></li></ul></li><li><a class="tocitem" href="../surface_fluxes/">Surface fluxes</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5" type="checkbox"/><label class="tocitem" for="menuitem-5"><span class="docs-label">Discretization</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../spectral_transform/">Spherical Harmonic Transform</a></li><li><a class="tocitem" href="../grids/">Grids</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-6" type="checkbox"/><label class="tocitem" for="menuitem-6"><span class="docs-label">Running SpeedyWeather</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../how_to_run_speedy/">How to run SpeedyWeather</a></li><li><a class="tocitem" href="../examples_2D/">Examples 2D</a></li><li><a class="tocitem" href="../examples_3D/">Examples 3D</a></li><li><a class="tocitem" href="../analysis/">Analysis</a></li><li><a class="tocitem" href="../structure/">Tree structure</a></li><li><a class="tocitem" href="../particles/">Particle advection</a></li><li><a class="tocitem" href="../output/">NetCDF output</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-7" type="checkbox"/><label class="tocitem" for="menuitem-7"><span class="docs-label">Extending SpeedyWeather</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../forcing_drag/">Forcing and drag</a></li><li><a class="tocitem" href="../parameterizations/">Parameterizations</a></li><li><a class="tocitem" href="../orography/">Orography</a></li><li><a class="tocitem" href="../land_sea_mask/">Land-Sea Mask</a></li><li><a class="tocitem" href="../ocean/">Ocean</a></li><li><a class="tocitem" href="../callbacks/">Callbacks</a></li></ul></li><li><a class="tocitem" href="../ringgrids/">RingGrids</a></li><li><a class="tocitem" href="../lowertriangularmatrices/">LowerTriangularMatrices</a></li><li><input class="collapse-toggle" id="menuitem-10" type="checkbox"/><label class="tocitem" for="menuitem-10"><span class="docs-label">SpeedyTransforms</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../speedytransforms/">Spectral transforms</a></li><li><a class="tocitem" href="../gradients/">Gradient operators</a></li></ul></li><li><a class="tocitem" href="../functions/">Function and type index</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Physics</a></li><li class="is-active"><a href>Vertical diffusion</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Vertical diffusion</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/SpeedyWeather/SpeedyWeather.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/SpeedyWeather/SpeedyWeather.jl/blob/main/docs/src/vertical_diffusion.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Vertical-diffusion"><a class="docs-heading-anchor" href="#Vertical-diffusion">Vertical diffusion</a><a id="Vertical-diffusion-1"></a><a class="docs-heading-anchor-permalink" href="#Vertical-diffusion" title="Permalink"></a></h1><p>Vertical diffusion in SpeedyWeather.jl is implemented as a Laplacian in the vertical <a href="../primitiveequation/#Sigma-coordinates">Sigma coordinates</a> with a diffusion coefficient <span>$K$</span> that in general depends on space and time and is flow-aware, meaning it is recalculated on every time step depending on the vertical stability of the atmospheric column.</p><p>Vertical diffusion can be applied to velocities <span>$u, v$</span>, temperature <span>$T$</span> (done via dry static energy, see below) and specific humidity <span>$q$</span>.</p><h2 id="Implementations"><a class="docs-heading-anchor" href="#Implementations">Implementations</a><a id="Implementations-1"></a><a class="docs-heading-anchor-permalink" href="#Implementations" title="Permalink"></a></h2><p>The following schemes for vertical diffusion are currently implemented</p><pre><code class="language-julia hljs">using SpeedyWeather
subtypes(SpeedyWeather.AbstractVerticalDiffusion)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">2-element Vector{Any}:
 BulkRichardsonDiffusion
 NoVerticalDiffusion</code></pre><p><code>NoVerticalDiffusion</code> disabled all vertical diffusion, <code>BulkRichardsonDiffusion</code> is explained in the following.</p><h2 id="Laplacian-in-sigma-coordinates"><a class="docs-heading-anchor" href="#Laplacian-in-sigma-coordinates">Laplacian in sigma coordinates</a><a id="Laplacian-in-sigma-coordinates-1"></a><a class="docs-heading-anchor-permalink" href="#Laplacian-in-sigma-coordinates" title="Permalink"></a></h2><p>The vertical diffusion of a variable, say <span>$u$</span>, takes the in sigma coordinates the form</p><p class="math-container">\[\frac{\partial u}{\partial t} = \frac{\partial}{\partial \sigma} K
\frac{\partial u}{\partial \sigma}\]</p><p>as a tendency to <span>$u$</span> with no-flux boundary conditions <span>$\frac{\partial u}{\partial \sigma} = 0$</span> at <span>$\sigma = 0$</span> (top of the atmosphere) and <span>$\sigma = 1$</span> (the surface). That way the diffusion preserves the integral of the variable <span>$u$</span> from <span>$\sigma = 0$</span> to <span>$\sigma = 1$</span>.</p><p class="math-container">\[\frac{\partial}{\partial t} \int_0^1 u d\sigma  = \int_0^1 \frac{\partial}{\partial \sigma} K
\frac{\partial u}{\partial \sigma} d\sigma = 
K\frac{\partial u}{\partial \sigma} \vert_{\sigma = 1} - K\frac{\partial u}{\partial \sigma} \vert_{\sigma = 0}
= 0\]</p><p>Discretising the diffusion operator <span>$\partial_\sigma K \partial_\sigma$</span> over <span>$N$</span> vertical layers <span>$k = 1...N$</span> with <span>$u_k$</span>, <span>$K_k$</span> on those layers at respective coordinates <span>$\sigma_k$</span> that are generally not equally spaced using centred finite differences</p><p class="math-container">\[\frac{\partial}{\partial \sigma} K \frac{\partial u}{\partial \sigma} \approx
\frac{
    \frac{K_{k+1} + K_k}{2}     \frac{u_{k+1} - u_k    }{\sigma_k+1 - \sigma_k} - 
    \frac{K_{k}   + K_{k-1}}{2} \frac{u_{k}   - u_{k-1}}{\sigma_k   - \sigma_{k-1}}
}{
    \sigma_{k+1/2} - \sigma_{k-1/2}
}\]</p><p>We reconstruct <span>$K$</span> on the faces <span>$k+1/2$</span> with a simple arithmetic average of <span>$K_k$</span> and <span>$K_{k+1}$</span>. This is necessary for the multiplication with the gradients which are only available on the faces after the centred gradients are computed. We then take the gradient again to obtain the final tendencies again at cell centres <span>$k$</span>.</p><h2 id="Bulk-Richardson-based-diffusion-coefficient"><a class="docs-heading-anchor" href="#Bulk-Richardson-based-diffusion-coefficient">Bulk Richardson-based diffusion coefficient</a><a id="Bulk-Richardson-based-diffusion-coefficient-1"></a><a class="docs-heading-anchor-permalink" href="#Bulk-Richardson-based-diffusion-coefficient" title="Permalink"></a></h2><p>We calculate the diffusion coefficient <span>$K$</span> based on the bulk Richardson number <span>$Ri$</span> <sup class="footnote-reference"><a id="citeref-Frierson2006" href="#footnote-Frierson2006">[Frierson2006]</a></sup> which is computed as follows</p><p class="math-container">\[Ri = \frac{gz \left( \Theta_v(z) - \Theta_v(z_N) \right)}{|v(z)|^2 \Theta_v(z_N)}\]</p><p>(see <a href="../surface_fluxes/#Bulk-Richardson-based-drag-coefficient">Bulk Richardson-based drag coefficient</a> in comparison). Gravitational acceleration is <span>$g$</span>, height <span>$z$</span>, <span>$\Theta_v$</span> the virtual potential temperature where we use the virtual dry static energy <span>$c_pT_v + gz$</span> with <span>$T_v$</span> the <a href="../primitiveequation/#Virtual-temperature">Virtual temperature</a>. The boundary layer height <span>$h$</span> (vertical index <span>$k_h$</span>) is defined as the height of the lowermost layer where <span>$Ri_{k_h} &gt; Ri_c$</span> with <span>$Ri_c = 1$</span> the critical Richardson number.</p><p>The diffusion coefficient <span>$K$</span> is for every layer <span>$k \geq k_h$</span> in the boundary layer calculated depending on the height <span>$z$</span> of a layer and its bulk Richardson number <span>$Ri$</span>.</p><p class="math-container">\[K(z) = \begin{cases}
    K_b(z) \quad &amp;\text{for} \quad z \leq f_b h \\
    K_b(f_b h) \frac{z}{f_b h} \left( 1 - \frac{z - f_b h}{(1 - f_b)h} \right)^2
        \quad &amp;\text{for} \quad f_b h &lt; z \leq h \\
\end{cases}\]</p><p>with <span>$f_b = 0.1$</span> the fraction of the boundary layer height <span>$h$</span> above which the second case guarantees a smooth transition in <span>$K$</span> to zero at <span>$z = h$</span>. <span>$K_b(z)$</span> is then defined as</p><p class="math-container">\[Kb(z) = \begin{cases}
    \kappa u_N \sqrt{C}z \quad &amp;\text{for} \quad Ri_N \leq 0 \\
    \kappa u_N \sqrt{C}z \left( 1 + \frac{Ri}{Ri_c}\frac{\log(z/z_0)}{1 - Ri/Ri_c}\right)^{-1}
        \quad &amp;\text{for} \quad Ri_N &gt; 0 \\
\end{cases}\]</p><p><span>$C$</span> is the surface drag coefficient as computed in <a href="../surface_fluxes/#Bulk-Richardson-based-drag-coefficient">Bulk Richardson-based drag coefficient</a>. The subscript <span>$N$</span> denotes the lowermost model layer <span>$k=N$</span>.</p><p>As for the <a href="../surface_fluxes/#Bulk-Richardson-based-drag-coefficient">Bulk Richardson-based drag coefficient</a> we also simplify this calculation here by approximating <span>$\log(z/z_0) \approx \log(Z/z_0)$</span> with the height Z of the lowermost layer given resolution and a reference surface temperature, for more details see description in that section.</p><h2 id="Vertical-diffusion-tendencies"><a class="docs-heading-anchor" href="#Vertical-diffusion-tendencies">Vertical diffusion tendencies</a><a id="Vertical-diffusion-tendencies-1"></a><a class="docs-heading-anchor-permalink" href="#Vertical-diffusion-tendencies" title="Permalink"></a></h2><p>The vertical diffusion is then computed as a tendency for <span>$u, v, q$</span> and temperature <span>$T$</span> via the dry static energy <span>$SE = c_p T + gz$</span>, i.e.</p><p class="math-container">\[\frac{\partial T}{\partial t} = \frac{1}{c_p}\frac{\partial}{\partial \sigma} K
\frac{\partial SE}{\partial \sigma} \]</p><p>where we just fold the heat capacity <span>$c_p$</span> into the diffusion coefficient <span>$K \to K/c_p$</span>. The other variables are diffused straight-forwardly as <span>$\partial_t u = \partial_\sigma K \partial_\sigma u$</span>, etc.</p><h2 id="References"><a class="docs-heading-anchor" href="#References">References</a><a id="References-1"></a><a class="docs-heading-anchor-permalink" href="#References" title="Permalink"></a></h2><section class="footnotes is-size-7"><ul><li class="footnote" id="footnote-Frierson2006"><a class="tag is-link" href="#citeref-Frierson2006">Frierson2006</a>Frierson, D. M. W., I. M. Held, and P. Zurita-Gotor, 2006: A Gray-Radiation Aquaplanet Moist GCM. Part I: Static Stability and Eddy Scale. J. Atmos. Sci., 63, 2548-2566. DOI: <a href="https://doi.org/10.1175/JAS3753.1">10.1175/JAS3753.1</a>.</li></ul></section></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../radiation/">« Radiation</a><a class="docs-footer-nextpage" href="../surface_fluxes/">Surface fluxes »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.4.1 on <span class="colophon-date" title="Tuesday 7 May 2024 08:04">Tuesday 7 May 2024</span>. Using Julia version 1.10.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
