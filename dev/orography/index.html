<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Orography · SpeedyWeather.jl</title><meta name="title" content="Orography · SpeedyWeather.jl"/><meta property="og:title" content="Orography · SpeedyWeather.jl"/><meta property="twitter:title" content="Orography · SpeedyWeather.jl"/><meta name="description" content="Documentation for SpeedyWeather.jl."/><meta property="og:description" content="Documentation for SpeedyWeather.jl."/><meta property="twitter:description" content="Documentation for SpeedyWeather.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">SpeedyWeather.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../installation/">Installation</a></li><li><input class="collapse-toggle" id="menuitem-3" type="checkbox"/><label class="tocitem" for="menuitem-3"><span class="docs-label">Dynamics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../barotropic/">Barotropic model</a></li><li><a class="tocitem" href="../shallowwater/">Shallow water model</a></li><li><a class="tocitem" href="../primitiveequation/">Primitive equation model</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4" type="checkbox"/><label class="tocitem" for="menuitem-4"><span class="docs-label">Physics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../large_scale_condensation/">Large-scale condensation</a></li><li><a class="tocitem" href="../convection/">Convection</a></li><li><a class="tocitem" href="../radiation/">Radiation</a></li><li><a class="tocitem" href="../vertical_diffusion/">Vertical diffusion</a></li><li><a class="tocitem" href="../surface_fluxes/">Surface fluxes</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5" type="checkbox"/><label class="tocitem" for="menuitem-5"><span class="docs-label">Discretization</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../spectral_transform/">Spherical Harmonic Transform</a></li><li><a class="tocitem" href="../grids/">Grids</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-6" type="checkbox"/><label class="tocitem" for="menuitem-6"><span class="docs-label">Running SpeedyWeather</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../how_to_run_speedy/">How to run SpeedyWeather</a></li><li><a class="tocitem" href="../examples_2D/">Examples 2D</a></li><li><a class="tocitem" href="../examples_3D/">Examples 3D</a></li><li><a class="tocitem" href="../analysis/">Analysis</a></li><li><a class="tocitem" href="../structure/">Tree structure</a></li><li><a class="tocitem" href="../particles/">Particle advection</a></li><li><a class="tocitem" href="../output/">NetCDF output</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-7" type="checkbox" checked/><label class="tocitem" for="menuitem-7"><span class="docs-label">Extending SpeedyWeather</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../forcing_drag/">Forcing and drag</a></li><li><a class="tocitem" href="../parameterizations/">Parameterizations</a></li><li class="is-active"><a class="tocitem" href>Orography</a><ul class="internal"><li><a class="tocitem" href="#Orographies-implemented"><span>Orographies implemented</span></a></li><li><a class="tocitem" href="#Earth&#39;s-orography"><span>Earth&#39;s orography</span></a></li><li><a class="tocitem" href="#Load-orography-from-file"><span>Load orography from file</span></a></li><li><a class="tocitem" href="#Changing-orography-manually"><span>Changing orography manually</span></a></li><li><a class="tocitem" href="#Defining-a-new-orography-type"><span>Defining a new orography type</span></a></li></ul></li><li><a class="tocitem" href="../land_sea_mask/">Land-Sea Mask</a></li><li><a class="tocitem" href="../ocean/">Ocean</a></li><li><a class="tocitem" href="../callbacks/">Callbacks</a></li></ul></li><li><a class="tocitem" href="../ringgrids/">RingGrids</a></li><li><a class="tocitem" href="../lowertriangularmatrices/">LowerTriangularMatrices</a></li><li><input class="collapse-toggle" id="menuitem-10" type="checkbox"/><label class="tocitem" for="menuitem-10"><span class="docs-label">SpeedyTransforms</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../speedytransforms/">Spectral transforms</a></li><li><a class="tocitem" href="../gradients/">Gradient operators</a></li></ul></li><li><a class="tocitem" href="../functions/">Function and type index</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Extending SpeedyWeather</a></li><li class="is-active"><a href>Orography</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Orography</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/SpeedyWeather/SpeedyWeather.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/SpeedyWeather/SpeedyWeather.jl/blob/main/docs/src/orography.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Orography"><a class="docs-heading-anchor" href="#Orography">Orography</a><a id="Orography-1"></a><a class="docs-heading-anchor-permalink" href="#Orography" title="Permalink"></a></h1><p>Orography (in height above the surface) forms the surface boundary of the lowermost layer in SpeedyWeather. </p><p>In the <a href="../shallowwater/#shallow_water_model">shallow-water equations</a> the orography <span>$H_b$</span> enters the equations when computing the layer thickness <span>$h = \eta + H_0 - H_b$</span> for the volume fluxes <span>$\mathbf{u}h$</span> in the continuity equation. Here, the orography is used in meters above the surface which shortens <span>$h$</span> over mountains. The orography here is needed in grid-point space.</p><p>In the <a href="../primitiveequation/#primitive_equation_model">primitive equations</a> the orography enters the equations when computing the <a href="../primitiveequation/#Geopotential">Geopotential</a>. So actually required here is the surface geopotential <span>$\Phi_s = gz_s$</span> where <span>$z_s$</span> is the orography height in meters as used in the shallow-water equations too <span>$z_s = H_b$</span>. However, the primitive equations require the orography in spectral space as the geopotential calculation is a linear operation in the horizontal and can therefore be applied in either grid-point or spectral space. The latter is more convenient as SpeedyWeather solves the equations to avoid additional transforms.</p><p>In the current formulation of the <a href="../barotropic/#barotropic_vorticity_model">barotropic vorticity equations</a> there is no orography. In fact, the field <code>model.orography</code> is not defined for <code>model::BarotropicModel</code>.</p><h2 id="Orographies-implemented"><a class="docs-heading-anchor" href="#Orographies-implemented">Orographies implemented</a><a id="Orographies-implemented-1"></a><a class="docs-heading-anchor-permalink" href="#Orographies-implemented" title="Permalink"></a></h2><p>Currently implemented are</p><pre><code class="language-julia hljs">using SpeedyWeather
subtypes(SpeedyWeather.AbstractOrography)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">3-element Vector{Any}:
 EarthOrography
 NoOrography
 ZonalRidge</code></pre><p>which are </p><ul><li><span>$\Phi_s = z_s = H_b = 0$</span> for <code>NoOrography</code></li><li>For <code>ZonalRidge</code> the zonal ridge from the Jablonowski and Williamson initial conditions, see <a href="../examples_3D/#Jablonowski-Williamson-baroclinic-wave">Jablonowski-Williamson baroclinic wave</a></li><li>For <code>EarthOrography</code> a high-resolution orography is loaded and interpolated to the resolution as defined by <code>spectral_grid</code>.</li></ul><p>all orographies need to be created with <code>spectral_grid::SpectralGrid</code> as the first argument, so that the respective fields for <code>geopot_surf</code>, i.e. <span>$\Phi_s$</span> and <code>orography</code>, i.e. <span>$H_b$</span> can be allocated in the right size and number format.</p><h2 id="Earth&#39;s-orography"><a class="docs-heading-anchor" href="#Earth&#39;s-orography">Earth&#39;s orography</a><a id="Earth&#39;s-orography-1"></a><a class="docs-heading-anchor-permalink" href="#Earth&#39;s-orography" title="Permalink"></a></h2><p>Earth&#39;s orography can be created with (here we use a resolution of T85, about 165km globally)</p><pre><code class="language-julia hljs">using SpeedyWeather
spectral_grid = SpectralGrid(trunc=85)
orography = EarthOrography(spectral_grid)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">EarthOrography{Float32, OctahedralGaussianGrid{Float32}} &lt;: SpeedyWeather.AbstractOrography
├ path::String = SpeedyWeather.jl/input_data
├ file::String = orography.nc
├ file_Grid::UnionAll = FullGaussianGrid
├ scale::Float64 = 1.0
├ smoothing::Bool = false
├ smoothing_power::Float64 = 1.0
├ smoothing_strength::Float64 = 0.1
├ smoothing_truncation::Int64 = 85
└── arrays: orography, geopot_surf</code></pre><p>but note that only allocates the orography, it does not actually load and interpolate the orography which happens at the <code>initialize!</code> step. Visualised with</p><pre><code class="language-julia hljs">model = PrimitiveDryModel(;spectral_grid, orography)
initialize!(orography, model)   # happens also in simulation = initialize!(model)

using CairoMakie
heatmap(orography.orography, title=&quot;Earth&#39;s orography at T85 resolution, no smoothing&quot;)</code></pre><p><img src="../earth_orography.png" alt="EarthOrography"/></p><p>typing <code>?EarthOrography</code> shows the various options that are provided. An orogaphy at T85 resolution that is as smooth as it would be at T31 for example can be created with</p><pre><code class="language-julia hljs">orography = EarthOrography(spectral_grid, smoothing=true, smoothing_truncation=31)
initialize!(orography, model)

heatmap(orography.orography, title=&quot;Earth&#39;s orography at T85 resolution, smoothed to T31&quot;)</code></pre><p><img src="../earth_orography_smooth.png" alt="EarthOrography_smooth"/></p><h2 id="Load-orography-from-file"><a class="docs-heading-anchor" href="#Load-orography-from-file">Load orography from file</a><a id="Load-orography-from-file-1"></a><a class="docs-heading-anchor-permalink" href="#Load-orography-from-file" title="Permalink"></a></h2><p>The easiest to load another orography from a netCDF file is to reuse the <code>EarthOrography</code>, e.g.</p><pre><code class="language-julia hljs">mars_orography = EarthOrography(spectal_grid, 
                                path=&quot;path/to/my/orography&quot;,
                                file=&quot;mars_orography.nc&quot;,
                                file_Grid=FullClenshawGrid)</code></pre><p>the orography itself need to come on one of the full grids SpeedyWeather defines, i.e. <code>FullGaussianGrid</code> or <code>FullClenshawGrid</code> (a regular lat-lon grid, see <a href="../grids/#FullClenshawGrid">FullClenshawGrid</a>), which you can specify. Best to inspect the correct orientation with <code>plot(mars_orography.orography)</code> (where the first is whatever name you chose here). You can use smoothing as above.</p><h2 id="Changing-orography-manually"><a class="docs-heading-anchor" href="#Changing-orography-manually">Changing orography manually</a><a id="Changing-orography-manually-1"></a><a class="docs-heading-anchor-permalink" href="#Changing-orography-manually" title="Permalink"></a></h2><p>You can also change orography manually, that means by mutating the elements in either <code>orography.orography</code> (to set it for the shallow-water model) or <code>orography.geopot_surf</code> (for the primitive equations, but this is in spectral space, advanced!). After the orography has been initialised (for testing to <code>initialize!(orography, model)</code> but in most cases when  you do <code>simulation = initialize!(model)</code>), for example you can do</p><pre><code class="language-julia hljs">sort!(orography.orography)</code></pre><p>to move all mountains to the south pole, or</p><pre><code class="language-julia hljs">orography.orography[1] = 100</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">100</code></pre><p>to set the grid point <code>1</code> (at 0˚E, on the first ring around the north pole) to a height of 100m. Whichever way you tweak the orography manually you want to reflect this in the surface geopotential <code>geopot_surf</code> which is used in the primitive equations by</p><pre><code class="language-julia hljs">spectral!(orography.geopot_surf, orography.orography, model.spectral_transform)
orography.geopot_surf .*= model.planet.gravity
spectral_truncation!(orography.geopot_surf)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">87×86 LowerTriangularMatrix{ComplexF32}:
  8128.89+0.0im        0.0+0.0im      …        0.0+0.0im
 -11343.6+0.0im  -0.250164-62.7652im           0.0+0.0im
  9145.52+0.0im   0.387434+88.0503im           0.0+0.0im
 -6096.53+0.0im  -0.256581-83.662im            0.0+0.0im
  3801.03+0.0im   0.498552+67.7109im           0.0+0.0im
 -3023.58+0.0im  -0.583525-65.5102im  …        0.0+0.0im
  2469.13+0.0im   0.942696+62.3633im           0.0+0.0im
 -2008.15+0.0im   -1.16472-58.0854im           0.0+0.0im
  1469.19+0.0im    1.79077+48.152im            0.0+0.0im
 -1221.53+0.0im   -1.87795-45.3532im           0.0+0.0im
         ⋮                            ⋱           ⋮
   10.638+0.0im  -0.244994+4.08215im           0.0+0.0im
 -17.0566+0.0im  -0.594592-7.62941im           0.0+0.0im
  16.8156+0.0im   0.246822+6.492im    …        0.0+0.0im
 -23.3235+0.0im  -0.930977-10.0837im           0.0+0.0im
  21.4603+0.0im  0.0634889+8.81341im           0.0+0.0im
 -24.6804+0.0im  -0.145654-11.4312im           0.0+0.0im
  19.5045+0.0im   -1.48764+8.58993im           0.0+0.0im
 -18.9074+0.0im    1.79103-9.28674im  …  0.0992537-0.0562888im
      0.0+0.0im        0.0+0.0im               0.0+0.0im</code></pre><p>In the first line, the surface geopotential is still missing the gravity, which is multiplied in the second line. The <code>spectral_truncation!</code> only removes the <span>$l_{max}+1$</span> degree of the spherical harmonics that scalar fields do not use, see <a href="../gradients/#One-more-degree-for-spectral-fields">One more degree for spectral fields</a>.</p><h2 id="Defining-a-new-orography-type"><a class="docs-heading-anchor" href="#Defining-a-new-orography-type">Defining a new orography type</a><a id="Defining-a-new-orography-type-1"></a><a class="docs-heading-anchor-permalink" href="#Defining-a-new-orography-type" title="Permalink"></a></h2><p>You can also define a new orography like we defined <code>ZonalRidge</code> or <code>EarthOrography</code>. The following explains what&#39;s necessary for this. The new <code>MyOrography</code> has to be defined as (<code>mutable</code> or not, but always with <code>@kwdef</code>)</p><pre><code class="language-julia hljs">@kwdef struct MyOrography{NF, Grid&lt;:RingGrids.AbstractGrid{NF}} &lt;: SpeedyWeather.AbstractOrography
    # optional, any parameters as fields here, e.g.
    constant_height::Float64 = 100
    # add some other parameters with default values

    # mandatory, every &lt;:AbstractOrography needs those (same name, same type)
    orography::Grid                                 # in grid-point space [m]
    geopot_surf::LowerTriangularMatrix{Complex{NF}} # in spectral space *gravity [m^2/s^2]
end</code></pre><p>for convenience with a generator function is automatically defined for all <code>AbstractOrography</code></p><pre><code class="language-julia hljs">my_orography = MyOrography(spectral_grid, constant_height=200)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Main.MyOrography{Float32, OctahedralGaussianGrid{Float32}} &lt;: SpeedyWeather.AbstractOrography
├ constant_height::Float64 = 200.0
└── arrays: orography, geopot_surf</code></pre><p>Now we have to extend the <code>initialize!</code> function. The first argument has to be <code>::MyOrography</code> i.e. the new type we just defined, the second argument has to be <code>::ModelSetup</code> although you could constrain it to <code>::ShallowWater</code> for example but then it cannot be used for primitive equations.</p><pre><code class="language-julia hljs">function SpeedyWeather.initialize!(
    orog::MyOrography,      # first argument as to be ::MyOrography, i.e. your new type
    model::ModelSetup,      # second argument, use anything from model read-only
)
    (; orography, geopot_surf) = orog   # unpack

    # maybe use lat, lon coordinates (in degree or radians)
    (; latds, londs, lats, lons) = model.geometry

    # change here the orography grid [m], e.g.
    orography .= orography.constant_height

    # then also calculate the surface geopotential for primitive equations
    # given orography we just set
    spectral!(geopot_surf, orography, model.spectral_transform)
    geopot_surf .*= model.planet.gravity
    spectral_truncation!(geopot_surf)
    return nothing
end</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../parameterizations/">« Parameterizations</a><a class="docs-footer-nextpage" href="../land_sea_mask/">Land-Sea Mask »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.4.1 on <span class="colophon-date" title="Monday 6 May 2024 22:45">Monday 6 May 2024</span>. Using Julia version 1.10.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
