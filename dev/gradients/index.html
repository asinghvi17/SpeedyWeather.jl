<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Gradient operators · SpeedyWeather.jl</title><meta name="title" content="Gradient operators · SpeedyWeather.jl"/><meta property="og:title" content="Gradient operators · SpeedyWeather.jl"/><meta property="twitter:title" content="Gradient operators · SpeedyWeather.jl"/><meta name="description" content="Documentation for SpeedyWeather.jl."/><meta property="og:description" content="Documentation for SpeedyWeather.jl."/><meta property="twitter:description" content="Documentation for SpeedyWeather.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">SpeedyWeather.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../installation/">Installation</a></li><li><input class="collapse-toggle" id="menuitem-3" type="checkbox"/><label class="tocitem" for="menuitem-3"><span class="docs-label">Dynamics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../barotropic/">Barotropic model</a></li><li><a class="tocitem" href="../shallowwater/">Shallow water model</a></li><li><a class="tocitem" href="../primitiveequation/">Primitive equation model</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4" type="checkbox"/><label class="tocitem" for="menuitem-4"><span class="docs-label">Physics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../large_scale_condensation/">Large-scale condensation</a></li><li><a class="tocitem" href="../convection/">Convection</a></li><li><a class="tocitem" href="../radiation/">Radiation</a></li><li><a class="tocitem" href="../vertical_diffusion/">Vertical diffusion</a></li><li><a class="tocitem" href="../surface_fluxes/">Surface fluxes</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5" type="checkbox"/><label class="tocitem" for="menuitem-5"><span class="docs-label">Discretization</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../spectral_transform/">Spherical Harmonic Transform</a></li><li><a class="tocitem" href="../grids/">Grids</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-6" type="checkbox"/><label class="tocitem" for="menuitem-6"><span class="docs-label">Running SpeedyWeather</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../how_to_run_speedy/">How to run SpeedyWeather</a></li><li><a class="tocitem" href="../examples_2D/">Examples 2D</a></li><li><a class="tocitem" href="../examples_3D/">Examples 3D</a></li><li><a class="tocitem" href="../analysis/">Analysis</a></li><li><a class="tocitem" href="../structure/">Tree structure</a></li><li><a class="tocitem" href="../particles/">Particle advection</a></li><li><a class="tocitem" href="../output/">NetCDF output</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-7" type="checkbox"/><label class="tocitem" for="menuitem-7"><span class="docs-label">Extending SpeedyWeather</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../forcing_drag/">Forcing and drag</a></li><li><a class="tocitem" href="../parameterizations/">Parameterizations</a></li><li><a class="tocitem" href="../orography/">Orography</a></li><li><a class="tocitem" href="../land_sea_mask/">Land-Sea Mask</a></li><li><a class="tocitem" href="../ocean/">Ocean</a></li><li><a class="tocitem" href="../callbacks/">Callbacks</a></li></ul></li><li><a class="tocitem" href="../ringgrids/">RingGrids</a></li><li><a class="tocitem" href="../lowertriangularmatrices/">LowerTriangularMatrices</a></li><li><input class="collapse-toggle" id="menuitem-10" type="checkbox" checked/><label class="tocitem" for="menuitem-10"><span class="docs-label">SpeedyTransforms</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../speedytransforms/">Spectral transforms</a></li><li class="is-active"><a class="tocitem" href>Gradient operators</a><ul class="internal"><li><a class="tocitem" href="#Gradient-operators"><span>Gradient operators</span></a></li><li><a class="tocitem" href="#Gradient"><span>Gradient <code>∇</code></span></a></li><li><a class="tocitem" href="#Geostrophy"><span>Geostrophy</span></a></li><li><a class="tocitem" href="#One-more-degree-for-spectral-fields"><span>One more degree for spectral fields</span></a></li><li><a class="tocitem" href="#Example:-Geostrophy-(continued)"><span>Example: Geostrophy (continued)</span></a></li></ul></li></ul></li><li><a class="tocitem" href="../functions/">Function and type index</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">SpeedyTransforms</a></li><li class="is-active"><a href>Gradient operators</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Gradient operators</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/SpeedyWeather/SpeedyWeather.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/SpeedyWeather/SpeedyWeather.jl/blob/main/docs/src/gradients.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h2 id="Gradient-operators"><a class="docs-heading-anchor" href="#Gradient-operators">Gradient operators</a><a id="Gradient-operators-1"></a><a class="docs-heading-anchor-permalink" href="#Gradient-operators" title="Permalink"></a></h2><p><a href="../speedytransforms/#SpeedyTransforms">SpeedyTransforms</a> also includes many gradient operators to take derivatives in spherical harmonics. These are in particular <span>$\nabla, \nabla \cdot, \nabla \times, \nabla^2, \nabla^{-2}$</span>. We call them <code>divergence</code>, <code>curl</code>, <code>∇</code>, <code>∇²</code>, <code>∇⁻²</code> (as well as their in-place versions with <code>!</code>) within the limits of unicode characters and Julia syntax. These functions are defined for inputs being spectral coefficients (i.e. <code>LowerTriangularMatrix</code>) or gridded fields (i.e. <code>&lt;:AbstractGrid</code>) and also allow as an additional argument a spectral transform object (see <a href="../speedytransforms/#SpectralTransform">SpectralTransform</a>) which avoids recalculating it under the hood.</p><div class="admonition is-info"><header class="admonition-header">SpeedyTransforms assumes a unit sphere</header><div class="admonition-body"><p>The gradient operators in SpeedyTransforms generally assume a sphere of radius <span>$R=1$</span>. For the transforms themselves that does not make a difference, but the gradient operators <code>divergence</code>, <code>curl</code>, <code>∇</code>, <code>∇²</code>, <code>∇⁻²</code> omit the radius scaling unless you provide the optional keyword <code>radius</code> (or you can do <code>./= radius</code> manually).  Also note that meridional derivates in spectral space expect a <span>$\cos^{-1}(\theta)$</span> scaling. Details are always outlined in the respective docstrings, <code>?∇</code> for example.</p></div></div><p>The actually implemented operators are, in contrast to the mathematical <a href="../spectral_transform/#Derivatives-in-spherical-coordinates">Derivatives in spherical coordinates</a> due to reasons of scaling as follows. Let the implemented operators be <span>$\hat{\nabla}$</span> etc.</p><p class="math-container">\[\hat{\nabla} A = \left(\frac{\partial A}{\partial \lambda}, \cos(\theta)\frac{\partial A}{\partial \theta} \right) =
R\cos(\theta)\nabla A\]</p><p>So the zonal derivative omits the radius and the <span>$\cos^{-1}(\theta)$</span> scaling. The meridional derivative adds a <span>$\cos(\theta)$</span> due to a recursion relation being defined that way, which, however, is actually convenient because the whole operator is therefore scaled by <span>$R\cos(\theta)$</span>. The curl and divergence operators expect the input velocity fields to be scaled by <span>$\cos^{-1}(\theta)$</span>, i.e.</p><p class="math-container">\[\begin{aligned}
\hat{\nabla} \cdot (\cos^{-1}(\theta)\mathbf{u}) &amp;= \frac{\partial u}{\partial \lambda} +
\cos\theta\frac{\partial v}{\partial \theta} = R\nabla \cdot \mathbf{u}, \\
\hat{\nabla} \times (\cos^{-1}(\theta)\mathbf{u}) &amp;= \frac{\partial v}{\partial \lambda} -
\cos\theta\frac{\partial u}{\partial \theta} = R\nabla \times \mathbf{u}.
\end{aligned}\]</p><p>And the Laplace operators omit a <span>$R^2$</span> (radius <span>$R$</span>) scaling, i.e.</p><p class="math-container">\[\hat{\nabla}^{-2}A = \frac{1}{R^2}\nabla^{-2}A , \quad \hat{\nabla}^{2}A = R^2\nabla^{2}A\]</p><h2 id="Gradient"><a class="docs-heading-anchor" href="#Gradient">Gradient <code>∇</code></a><a id="Gradient-1"></a><a class="docs-heading-anchor-permalink" href="#Gradient" title="Permalink"></a></h2><p>We illustrate the usage of the gradient function <code>∇</code>. Let us create some fake data <code>G</code> on the grid first </p><pre><code class="language-julia hljs">using SpeedyWeather, CairoMakie

# create some data with wave numbers 0,1,2,3,4
trunc = 64                  # 1-based maximum degree of spherical harmonics
L = randn(LowerTriangularMatrix{ComplexF32}, trunc, trunc)
spectral_truncation!(L, 5)              # remove higher wave numbers
G = gridded(L)
heatmap(G, title=&quot;Some fake data G&quot;)    # requires `using CairoMakie`</code></pre><p><img src="../gradient_data.png" alt="Gradient data"/></p><p>Now we can take the gradient as follows</p><pre><code class="language-julia hljs">dGdx, dGdy = ∇(G)</code></pre><p>this transforms internally back to spectral space takes the gradients in zonal and meridional direction, transforms to grid-point space again und unscales the coslat-scaling on the fly but assumes a radius of 1 as the keyword argument <code>radius</code> was not provided. Use <code>∇(G, radius=6.371e6)</code> for a gradient on Earth in units of &quot;data unit&quot; divided by meters.</p><pre><code class="language-julia hljs">heatmap(dGdx, title=&quot;dG/dx on the unit sphere&quot;)
heatmap(dGdy, title=&quot;dG/dy on the unit sphere&quot;)</code></pre><p><img src="../dGdx.png" alt="dGdx"/> <img src="../dGdy.png" alt="dGdy"/></p><h2 id="Geostrophy"><a class="docs-heading-anchor" href="#Geostrophy">Geostrophy</a><a id="Geostrophy-1"></a><a class="docs-heading-anchor-permalink" href="#Geostrophy" title="Permalink"></a></h2><p>Now, we want to use the following example to illustrate a more complex use of the gradient operators: We have <span>$u, v$</span> and want to calculate <span>$\eta$</span> in the shallow water system from it following geostrophy. Analytically we have</p><p class="math-container">\[-fv = -g\partial_\lambda \eta, \quad fu = -g\partial_\theta \eta\]</p><p>which becomes, if you take the divergence of these two equations</p><p class="math-container">\[\zeta = \frac{g}{f}\nabla^2 \eta\]</p><p>Meaning that if we start with <span>$u, v$</span> we can obtain the relative vorticity <span>$\zeta$</span> and, using Coriolis parameter <span>$f$</span> and gravity <span>$g$</span>, invert the Laplace operator to obtain displacement <span>$\eta$</span>. How to do this with SpeedyTransforms? </p><p>Let us start by generating some data</p><pre><code class="language-julia hljs">spectral_grid = SpectralGrid(trunc=31, nlev=1)
forcing = SpeedyWeather.JetStreamForcing(spectral_grid)
drag = QuadraticDrag(spectral_grid)
model = ShallowWaterModel(; spectral_grid, forcing, drag)
simulation = initialize!(model);
run!(simulation, period=Day(30))</code></pre><p>Now pretend you only have <code>u, v</code> to get vorticity (which is actually the prognostic variable in the model, so calculated anyway...).</p><pre><code class="language-julia hljs">u = simulation.diagnostic_variables.layers[1].grid_variables.u_grid
v = simulation.diagnostic_variables.layers[1].grid_variables.v_grid
vor = curl(u, v, radius = spectral_grid.radius)</code></pre><p>Here, <code>u, v</code> are the grid-point velocity fields, and the function <code>curl</code> takes in either <code>LowerTriangularMatrix</code>s (no transform needed as all gradient operators act in spectral space), or, as shown here, arrays of the same grid and size. In this case, the function actually runs through the following steps</p><pre><code class="language-julia hljs">RingGrids.scale_coslat⁻¹!(u)
RingGrids.scale_coslat⁻¹!(v)

S = SpectralTransform(u, one_more_degree=true)
us = spectral(u, S)
vs = spectral(v, S)

vor = curl(us, vs, radius = spectral_grid.radius)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">33×32 LowerTriangularMatrix{ComplexF32}:
         0.0+0.0im          0.0+0.0im         …          0.0+0.0im
  1.46323f-6+0.0im   8.35837f-9-1.25423f-8im             0.0+0.0im
  4.41958f-6+0.0im   1.37011f-6-2.28875f-7im             0.0+0.0im
   2.7337f-5+0.0im   1.74752f-7-1.58266f-6im             0.0+0.0im
   1.4184f-5+0.0im   5.77233f-6-1.87291f-6im             0.0+0.0im
 -5.49653f-7+0.0im   6.41195f-6+5.29992f-6im  …          0.0+0.0im
  6.95385f-6+0.0im  -4.94769f-6+4.77012f-6im             0.0+0.0im
 -3.85821f-5+0.0im   2.65713f-6+2.6598f-6im              0.0+0.0im
 -6.99566f-6+0.0im   -3.0926f-6-9.11408f-7im             0.0+0.0im
  1.00761f-5+0.0im  -3.71756f-6-4.2234f-7im              0.0+0.0im
            ⋮                                 ⋱  
 -6.12072f-7+0.0im   3.10656f-7-2.97305f-7im             0.0+0.0im
  4.23184f-7+0.0im   3.45724f-9+1.41133f-7im  …          0.0+0.0im
  2.25271f-7+0.0im   2.34786f-8+2.39947f-7im             0.0+0.0im
   4.1683f-7+0.0im  -7.64275f-8+9.32658f-8im             0.0+0.0im
   1.0403f-7+0.0im   3.45011f-8-2.05382f-8im             0.0+0.0im
 -1.28862f-7+0.0im   -1.2395f-7-4.92863f-8im             0.0+0.0im
 -6.39719f-8+0.0im  -2.12141f-9-1.12735f-7im  …          0.0+0.0im
 -1.53366f-7+0.0im  -4.61159f-8-1.35114f-7im     -2.44029f-9-5.75814f-9im
         0.0+0.0im          0.0+0.0im                    0.0+0.0im</code></pre><p>(Copies of) the velocity fields are unscaled by the cosine of latitude (see above), then transformed into spectral space, and the <code>curl</code> has the keyword argument <code>radius</code> to divide internally by the radius (if not provided it assumes a unit sphere). We always unscale vector fields by the cosine of latitude if they are provided to <code>curl</code> or <code>divergence</code> in spectral as you can only do this scaling effectively in grid-point space. The methods accepting arguments as grids generally do this for you. If in doubt, check the docstrings, <code>?∇</code> for example.</p><h2 id="One-more-degree-for-spectral-fields"><a class="docs-heading-anchor" href="#One-more-degree-for-spectral-fields">One more degree for spectral fields</a><a id="One-more-degree-for-spectral-fields-1"></a><a class="docs-heading-anchor-permalink" href="#One-more-degree-for-spectral-fields" title="Permalink"></a></h2><p>The <code>SpectralTransform</code> in general takes a <code>one_more_degree</code> keyword argument, if otherwise the returned <code>LowerTriangularMatrix</code> would be of size 32x32, setting this to true would return 33x32. The reason is that while most people would expect square lower triangular matrices for a triangular spectral truncation, all vector quantities always need one more degree (= one more row) because of a recursion relation in the meridional gradient. So as we want to take the curl of <code>us, vs</code> here, they need this additional degree, but in the returned lower triangular matrix this row is set to zero.</p><div class="admonition is-info"><header class="admonition-header">One more degree for vector quantities</header><div class="admonition-body"><p>All gradient operators expect the input lower triangular matrices of shape <span>$(N+1) \times N$</span>. This one more degree of the spherical harmonics is required for the meridional derivative. Scalar quantities contain this degree too for size compatibility but they should not make use of it. Use <code>spectral_truncation</code> to add or remove this degree manually.</p></div></div><h2 id="Example:-Geostrophy-(continued)"><a class="docs-heading-anchor" href="#Example:-Geostrophy-(continued)">Example: Geostrophy (continued)</a><a id="Example:-Geostrophy-(continued)-1"></a><a class="docs-heading-anchor-permalink" href="#Example:-Geostrophy-(continued)" title="Permalink"></a></h2><p>Now we transfer <code>vor</code> into grid-point space, but specify that we want it on the grid that we also used in <code>spectral_grid</code>. The Coriolis parameter for a grid like <code>vor_grid</code> is obtained, and we do the following for <span>$f\zeta/g$</span>.</p><pre><code class="language-julia hljs">vor_grid = gridded(vor, Grid=spectral_grid.Grid)
f = coriolis(vor_grid)      # create Coriolis parameter f on same grid with default rotation
g = model.planet.gravity
fζ_g = @. vor_grid * f / g  # in-place and element-wise</code></pre><p>Now we need to apply the inverse Laplace operator to <span>$f\zeta/g$</span> which we do as follows</p><pre><code class="language-julia hljs">fζ_g_spectral = spectral(fζ_g, one_more_degree=true)

R = spectral_grid.radius
η = SpeedyTransforms.∇⁻²(fζ_g_spectral) * R^2
η_grid = gridded(η, Grid=spectral_grid.Grid)</code></pre><p>Note the manual scaling with the radius <span>$R^2$</span> here. We now compare the results</p><pre><code class="language-julia hljs">using CairoMakie
heatmap(η_grid, title=&quot;Geostrophic interface displacement η [m]&quot;)</code></pre><p><img src="../eta_geostrophic.png" alt="Geostrophic eta"/></p><p>Which is the interface displacement assuming geostrophy. The actual interface displacement contains also ageostrophy</p><pre><code class="language-julia hljs">η_grid2 = simulation.diagnostic_variables.surface.pres_grid
heatmap(η_grid2, title=&quot;Interface displacement η [m] with ageostrophy&quot;)</code></pre><p><img src="../eta_ageostrophic.png" alt="Ageostrophic eta"/></p><p>Strikingly similar! The remaining differences are the ageostrophic motions but also note that the mean is off. This is because geostrophy only use/defines the gradient of <span>$\eta$</span> not the absolute values itself. Our geostrophic <span>$\eta_g$</span> has by construction a mean of zero (that is how we define the inverse Laplace operator) but the actual <span>$\eta$</span> is some 1400m higher.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../speedytransforms/">« Spectral transforms</a><a class="docs-footer-nextpage" href="../functions/">Function and type index »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.4.1 on <span class="colophon-date" title="Monday 6 May 2024 16:44">Monday 6 May 2024</span>. Using Julia version 1.10.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
